<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>My Anime Hub</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    * { box-sizing: border-box; }

    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: radial-gradient(circle at top, #1f2937 0, #020617 45%, #000 100%);
      color: #e5e7eb;
    }

    .app {
      max-width: 1100px;
      margin: 0 auto;
      padding: 16px;
    }

    .top-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 12px;
      margin-bottom: 16px;
    }

    .top-bar h1 {
      margin: 0;
      font-size: 26px;
    }

    .subtitle {
      margin: 4px 0 0;
      font-size: 13px;
      color: #9ca3af;
    }

    .profile-card {
      display: flex;
      align-items: center;
      gap: 8px;
      background: rgba(15, 23, 42, 0.7);
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid #1f2937;
    }

    .avatar {
      width: 34px;
      height: 34px;
      border-radius: 999px;
      background: linear-gradient(135deg, #38bdf8, #a855f7);
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      font-size: 16px;
      color: #020617;
      overflow: hidden;
    }

    .profile-text {
      display: flex;
      flex-direction: column;
      font-size: 12px;
    }

    .card {
      background: rgba(15, 23, 42, 0.9);
      border-radius: 14px;
      margin-bottom: 14px;
      border: 1px solid #1f2937;
      box-shadow: 0 16px 40px rgba(0, 0, 0, 0.4);
    }

    .card-header {
      padding: 12px 16px 0;
    }

    .card-header h2 {
      margin: 0;
      font-size: 18px;
    }

    .card-subtitle {
      margin: 4px 0 0;
      font-size: 12px;
      color: #9ca3af;
    }

    .card-body {
      padding: 12px 16px 16px;
    }

    .row {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-bottom: 8px;
    }

    .grid-two {
      display: grid;
      grid-template-columns: 1fr;
      gap: 8px;
    }

    @media (min-width: 720px) {
      .grid-two {
        grid-template-columns: repeat(2, minmax(0, 1fr));
      }
    }

    label {
      font-size: 12px;
      color: #9ca3af;
      display: block;
      margin-bottom: 2px;
    }

    input,
    select {
      width: 100%;
      padding: 7px 9px;
      border-radius: 8px;
      border: 1px solid #374151;
      background: #020617;
      color: #e5e7eb;
      font-size: 13px;
    }

    input::placeholder {
      color: #6b7280;
    }

    button {
      border: none;
      padding: 7px 12px;
      border-radius: 999px;
      font-size: 13px;
      cursor: pointer;
      background: #38bdf8;
      color: #020617;
      font-weight: 600;
      white-space: nowrap;
    }

    button.secondary {
      background: #111827;
      color: #e5e7eb;
      border: 1px solid #4b5563;
    }

    button.small {
      padding: 4px 8px;
      font-size: 11px;
    }

    button:disabled {
      opacity: 0.5;
      cursor: default;
    }

    .hint {
      font-size: 11px;
      color: #9ca3af;
      margin-bottom: 8px;
    }

    .search-results {
      margin-top: 10px;
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .search-item {
      padding: 6px 8px;
      border-radius: 10px;
      border: 1px solid #1f2937;
      background: #020617;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
      font-size: 12px;
    }

    .details-panel {
      margin-top: 10px;
      border-radius: 10px;
      border: 1px solid #1f2937;
      padding: 10px;
      background: #020617;
      display: none;
    }

    .details-header {
      display: flex;
      gap: 10px;
    }

    .details-poster {
      width: 80px;
      border-radius: 8px;
      overflow: hidden;
      flex-shrink: 0;
    }

    .details-poster img {
      width: 100%;
    }

    .details-main h3 {
      margin: 0;
      font-size: 16px;
    }

    .details-main p {
      margin: 2px 0;
      font-size: 12px;
      color: #9ca3af;
    }

    .tag-pill {
      display: inline-flex;
      align-items: center;
      padding: 2px 7px;
      border-radius: 999px;
      background: #111827;
      font-size: 11px;
      margin: 2px 4px 2px 0;
    }

    .anime-list {
      display: flex;
      flex-direction: column;
      gap: 8px;
      margin-top: 8px;
    }

    .anime-card {
      display: grid;
      grid-template-columns: auto 1fr;
      gap: 10px;
      padding: 8px;
      border-radius: 10px;
      background: #020617;
      border: 1px solid #1f2937;
      font-size: 12px;
    }

    .anime-thumb {
      width: 60px;
      height: 80px;
      border-radius: 8px;
      overflow: hidden;
      background: #111827;
    }

    .anime-thumb img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .anime-info h3 {
      margin: 0;
      font-size: 14px;
    }

    .anime-info p {
      margin: 2px 0;
      color: #9ca3af;
    }

    .progress-bar-wrap {
      width: 100%;
      height: 8px;
      background: #020617;
      border-radius: 999px;
      border: 1px solid #1f2937;
      margin: 3px 0;
    }

    .progress-bar {
      height: 100%;
      border-radius: 999px;
      background: linear-gradient(90deg, #22c55e, #a855f7);
      width: 0;
    }

    .anime-actions {
      margin-top: 4px;
      display: flex;
      flex-wrap: wrap;
      gap: 4px;
    }

    .empty-text {
      font-size: 12px;
      color: #6b7280;
      margin-top: 6px;
    }

    .stats-list {
      list-style: none;
      padding: 0;
      margin: 0;
      font-size: 13px;
    }

    .stats-list li {
      display: flex;
      justify-content: space-between;
      margin-bottom: 3px;
    }

    .recommendations {
      list-style: none;
      padding: 0;
      margin: 4px 0 0;
      font-size: 12px;
    }

    .recommendations li {
      margin-bottom: 4px;
    }

    .bingo-grid {
      display: grid;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      gap: 4px;
    }

    .bingo-cell {
      font-size: 11px;
      padding: 6px;
      border-radius: 8px;
      background: #020617;
      border: 1px dashed #4b5563;
      cursor: pointer;
      text-align: center;
    }

    .bingo-cell.done {
      background: #22c55e33;
      border-style: solid;
    }

    #quote-text {
      font-size: 13px;
      margin-bottom: 2px;
    }

    #quote-meta {
      font-size: 11px;
      color: #9ca3af;
    }

    .status-tabs {
      display: flex;
      flex-wrap: wrap;
      gap: 4px;
      margin-bottom: 6px;
    }

    .status-tab {
      font-size: 11px;
      padding: 4px 10px;
    }

    .status-tab.active {
      background: #a855f7;
      color: #020617;
    }

    .footer {
      text-align: center;
      font-size: 11px;
      color: #6b7280;
      margin-top: 12px;
    }
  </style>
</head>
<body>
  <div class="app">
    <header class="top-bar">
      <div>
        <h1>My Anime Hub</h1>
        <p class="subtitle">Personal tracker â€¢ Watch order â€¢ Stats â€¢ Fun stuff</p>
      </div>
      <div class="profile-card">
        <div class="avatar" id="profile-avatar">AF</div>
        <div class="profile-text">
          <div id="profile-name-display">Anime Fan</div>
        </div>
      </div>
    </header>

    <!-- QUOTE -->
    <section class="card">
      <div class="card-header">
        <h2>Quote of the Day</h2>
      </div>
      <div class="card-body">
        <p id="quote-text">Loading quote...</p>
        <p id="quote-meta"></p>
      </div>
    </section>

    <!-- SEARCH -->
    <section class="card">
      <div class="card-header">
        <h2>Search Anime</h2>
        <p class="card-subtitle">
          Shows episodes, status, rating, basic watch order & manga info.
        </p>
      </div>
      <div class="card-body">
        <div class="row">
          <input id="search-input" type="text" placeholder="Type anime name, e.g. 'Attack on Titan'" />
          <button id="search-button">Search</button>
        </div>
        <div id="search-results" class="search-results"></div>
        <div id="search-details" class="details-panel"></div>
      </div>
    </section>

    <!-- MANUAL ADD -->
    <section class="card">
      <div class="card-header">
        <h2>Add Manual Anime</h2>
        <p class="card-subtitle">If something isn't in the search results, add it yourself.</p>
      </div>
      <div class="card-body">
        <div class="grid-two">
          <div>
            <label>Title</label>
            <input id="manual-title" type="text" placeholder="Anime title" />
          </div>
          <div>
            <label>Total episodes</label>
            <input id="manual-total" type="number" min="1" placeholder="e.g. 24" />
          </div>
          <div>
            <label>Minutes per episode</label>
            <input id="manual-minutes" type="number" min="1" placeholder="Default 24" />
          </div>
          <div>
            <label>Start episodes watched</label>
            <input id="manual-ep" type="number" min="0" placeholder="e.g. 0" />
          </div>
          <div>
            <label>Status</label>
            <select id="manual-status">
              <option value="watching">Watching</option>
              <option value="completed">Completed</option>
              <option value="rewatching">Rewatching</option>
              <option value="on-hold">On-hold</option>
              <option value="dropped">Dropped</option>
              <option value="plan">Plan to watch</option>
            </select>
          </div>
          <div>
            <label>Tags (comma separated)</label>
            <input id="manual-tags" type="text" placeholder="peak, sad, comfort" />
          </div>
        </div>
        <button id="manual-add-button">Add to library</button>
      </div>
    </section>

    <!-- LIBRARY -->
    <section class="card">
      <div class="card-header">
        <h2>My Anime Library</h2>
        <p class="card-subtitle">Click on a status tab to filter.</p>
      </div>
      <div class="card-body">
        <div class="status-tabs">
          <button data-filter="all" class="status-tab active">All</button>
          <button data-filter="watching" class="status-tab">Watching</button>
          <button data-filter="rewatching" class="status-tab">Rewatching</button>
          <button data-filter="completed" class="status-tab">Completed</button>
          <button data-filter="on-hold" class="status-tab">On-hold</button>
          <button data-filter="dropped" class="status-tab">Dropped</button>
          <button data-filter="plan" class="status-tab">Plan to watch</button>
        </div>
        <div id="anime-list" class="anime-list"></div>
        <p id="anime-empty" class="empty-text">No anime yet. Add some from search or manual section.</p>
      </div>
    </section>

    <!-- STATS -->
    <section class="card">
      <div class="card-header">
        <h2>Stats & Recommendations</h2>
      </div>
      <div class="card-body grid-two">
        <div>
          <h3>Stats</h3>
          <ul class="stats-list">
            <li><span>Total anime:</span> <span id="stat-total">0</span></li>
            <li><span>Completed:</span> <span id="stat-completed">0</span></li>
            <li><span>Episodes watched:</span> <span id="stat-episodes">0</span></li>
            <li><span>Estimated time watched:</span> <span id="stat-time">0 hrs</span></li>
            <li><span>Top genre (approx):</span> <span id="stat-genre">â€“</span></li>
          </ul>
        </div>
        <div>
          <h3>Simple Recommendations</h3>
          <p class="hint">Based on your most common genres.</p>
          <ul id="recommendations" class="recommendations"></ul>
        </div>
      </div>
    </section>

    <!-- BINGO -->
    <section class="card">
      <div class="card-header">
        <h2>Anime Bingo</h2>
      </div>
      <div class="card-body">
        <p class="hint">Tap squares youâ€™ve done. Saved in your browser.</p>
        <div id="bingo-grid" class="bingo-grid"></div>
      </div>
    </section>

    <footer class="footer">
      Built for fun â€¢ Data saved in your browser â€¢ Hosted on GitHub Pages
    </footer>
  </div>

  <script>
    // SIMPLE STATE
    const STORAGE_KEY = "myAnimeHub_simple_v1";
    let state = {
      anime: [],
      bingo: {}
    };
    let currentFilter = "all";

    function loadState() {
      try {
        const raw = localStorage.getItem(STORAGE_KEY);
        if (!raw) return;
        const parsed = JSON.parse(raw);
        if (parsed && typeof parsed === "object") state = Object.assign(state, parsed);
      } catch (e) {
        console.error(e);
      }
    }

    function saveState() {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
    }

    function createEl(tag, className, text) {
      const el = document.createElement(tag);
      if (className) el.className = className;
      if (text) el.textContent = text;
      return el;
    }

    function initialsFromName(name) {
      if (!name) return "AF";
      const parts = name.trim().split(/\s+/);
      if (parts.length === 1) return parts[0][0].toUpperCase();
      return (parts[0][0] + parts[1][0]).toUpperCase();
    }

    // PROFILE (static for now)
    function renderProfile() {
      const name = "Anime Fan";
      document.getElementById("profile-name-display").textContent = name;
      document.getElementById("profile-avatar").textContent = initialsFromName(name);
    }

    // QUOTE
    const QUOTES = [
      {
        text: "Whatever you lose, youâ€™ll find it again. But what you throw away youâ€™ll never get back.",
        meta: "Kenshin Himura â€“ Rurouni Kenshin",
      },
      {
        text: "Peopleâ€™s lives donâ€™t end when they die, it ends when they lose faith.",
        meta: "Itachi Uchiha â€“ Naruto",
      },
      {
        text: "A lesson without pain is meaningless.",
        meta: "Edward Elric â€“ Fullmetal Alchemist: Brotherhood",
      },
      {
        text: "We each need to find our own inspiration. Sometimes, itâ€™s not easy.",
        meta: "Kiyoko Shimizu â€“ Haikyuu!!",
      },
      {
        text: "Itâ€™s okay to feel depressed. It takes time to overcome things.",
        meta: "Makoto â€“ Horimiya",
      },
    ];

    function renderQuote() {
      const qEl = document.getElementById("quote-text");
      const mEl = document.getElementById("quote-meta");
      const idx = Math.floor(Math.random() * QUOTES.length);
      const q = QUOTES[idx];
      qEl.textContent = '"' + q.text + '"';
      mEl.textContent = q.meta;
    }

    // ANIME MODEL
    function ensureAnimeArray() {
      if (!Array.isArray(state.anime)) state.anime = [];
    }

    function assignLocalIds() {
      ensureAnimeArray();
      state.anime.forEach((a, idx) => {
        if (!a.localId) a.localId = "local-" + idx + "-" + Date.now();
      });
    }

    function addOrUpdateAnime(entry) {
      ensureAnimeArray();
      const existingIndex = state.anime.findIndex(
        (a) => a.id && entry.id && a.id === entry.id && a.source === entry.source
      );
      if (existingIndex >= 0) {
        state.anime[existingIndex] = Object.assign({}, state.anime[existingIndex], entry);
      } else {
        state.anime.push(entry);
      }
      saveState();
      renderAnimeList();
      renderStatsAndRecs();
    }

    function removeAnime(localId) {
      ensureAnimeArray();
      state.anime = state.anime.filter((a) => a.localId !== localId);
      saveState();
      renderAnimeList();
      renderStatsAndRecs();
    }

    // RENDER LIBRARY
    function renderAnimeList() {
      assignLocalIds();
      const container = document.getElementById("anime-list");
      const emptyEl = document.getElementById("anime-empty");
      container.innerHTML = "";

      let list = state.anime;
      if (currentFilter !== "all") {
        list = list.filter((a) => a.status === currentFilter);
      }

      if (!list.length) {
        emptyEl.style.display = "block";
        return;
      }
      emptyEl.style.display = "none";

      list.forEach((anime) => {
        const card = createEl("div", "anime-card");

        const thumb = createEl("div", "anime-thumb");
        if (anime.imageUrl) {
          const img = document.createElement("img");
          img.src = anime.imageUrl;
          img.alt = anime.title;
          thumb.appendChild(img);
        }
        card.appendChild(thumb);

        const info = createEl("div", "anime-info");

        const titleRow = createEl("div");
        titleRow.appendChild(createEl("h3", null, anime.title));
        titleRow.appendChild(createEl("span", "tag-pill", (anime.status || "unknown").toUpperCase()));
        info.appendChild(titleRow);

        const meta = createEl(
          "p",
          null,
          (anime.type || "â€“") +
            " â€¢ " +
            (anime.airingStatus || "status?") +
            " â€¢ Score: " +
            (anime.score != null ? anime.score : "â€“")
        );
        info.appendChild(meta);

        const epsWatched = anime.episodesWatched || 0;
        const totalEps = anime.totalEpisodes || "?";
        const mins = anime.minutesPerEp || 24;
        info.appendChild(
          createEl("p", null, "Ep " + epsWatched + " / " + totalEps + " (" + mins + " min/ep)")
        );

        const progressWrap = createEl("div", "progress-bar-wrap");
        const progressBar = createEl("div", "progress-bar");
        if (typeof anime.totalEpisodes === "number" && anime.totalEpisodes > 0) {
          const ratio = Math.min(1, epsWatched / anime.totalEpisodes);
          progressBar.style.width = ratio * 100 + "%";
        } else {
          progressBar.style.width = "0%";
        }
        progressWrap.appendChild(progressBar);
        info.appendChild(progressWrap);

        if (anime.tags && anime.tags.length) {
          const tagsRow = createEl("div");
          anime.tags.forEach((t) => tagsRow.appendChild(createEl("span", "tag-pill", t)));
          info.appendChild(tagsRow);
        }

        const actions = createEl("div", "anime-actions");

        const plusBtn = createEl("button", "small", "+1 ep");
        plusBtn.onclick = () => {
          anime.episodesWatched = (anime.episodesWatched || 0) + 1;
          saveState();
          renderAnimeList();
          renderStatsAndRecs();
        };
        actions.appendChild(plusBtn);

        const statusSelect = document.createElement("select");
        ["watching", "rewatching", "completed", "on-hold", "dropped", "plan"].forEach((st) => {
          const opt = document.createElement("option");
          opt.value = st;
          opt.textContent = st;
          if (anime.status === st) opt.selected = true;
          statusSelect.appendChild(opt);
        });
        statusSelect.onchange = () => {
          anime.status = statusSelect.value;
          saveState();
          renderAnimeList();
          renderStatsAndRecs();
        };
        actions.appendChild(statusSelect);

        const removeBtn = createEl("button", "secondary small", "Remove");
        removeBtn.onclick = () => {
          removeAnime(anime.localId);
        };
        actions.appendChild(removeBtn);

        info.appendChild(actions);
        card.appendChild(info);
        container.appendChild(card);
      });
    }

    // STATS & RECOMMENDATIONS
function renderStatsAndRecs() {
  ensureAnimeArray();

  const total = state.anime.length;
  const completed = state.anime.filter((a) => a.status === "completed").length;
  const episodes = state.anime.reduce(
    (sum, a) => sum + (a.episodesWatched || 0),
    0
  );
  const minutes = state.anime.reduce(
    (sum, a) => sum + (a.episodesWatched || 0) * (a.minutesPerEp || 24),
    0
  );
  const hours = Math.round((minutes / 60) * 10) / 10;

  // write numbers into the page
  document.getElementById("stat-total").textContent = total;
  document.getElementById("stat-completed").textContent = completed;
  document.getElementById("stat-episodes").textContent = episodes;
  document.getElementById("stat-time").textContent = `${hours} hrs`;

  // ---- top genre ----
  const genreCounts = {};
  state.anime.forEach((a) => {
    if (!a.genres) return;
    a.genres.forEach((g) => {
      genreCounts[g] = (genreCounts[g] || 0) + 1;
    });
  });

  let topGenre = "â€“";
  let max = 0;
  Object.entries(genreCounts).forEach(([g, c]) => {
    if (c > max) {
      max = c;
      topGenre = g;
    }
  });

  document.getElementById("stat-genre").textContent = topGenre;

  // ---- simple recommendations ----
  const recList = document.getElementById("recommendations");
  recList.innerHTML = "";

  if (topGenre === "â€“") {
    recList.appendChild(
      createEl("li", null, "Add some anime first to get recommendations.")
    );
    return;
  }

  const candidates = state.anime.filter(
    (a) =>
      a.genres &&
      a.genres.includes(topGenre) &&
      a.status !== "completed"
  );

  if (!candidates.length) {
    recList.appendChild(
      createEl(
        "li",
        null,
        `No obvious picks yet. Try adding more ${topGenre} anime.`
      )
    );
    return;
  }

  candidates.slice(0, 5).forEach((a) => {
    recList.appendChild(
      createEl(
        "li",
        null,
        `${a.title} (${a.type || "?"}) â€“ status: ${a.status || "?"}`
      )
    );
  });
}
    
    // BINGO
    const BINGO_ITEMS = [
      "Cried because of anime",
      "Watched 100+ episodes",
      "Simps for a character",
      "Pulled an all-nighter",
      "Rewatched a series",
      "Argued about best girl",
      "Read manga after anime",
      "Watched filler knowingly",
      "Memorized an opening",
    ];

    function renderBingo() {
      const grid = document.getElementById("bingo-grid");
      grid.innerHTML = "";
      BINGO_ITEMS.forEach((text, idx) => {
        const id = "bingo-" + idx;
        const cell = createEl("div", "bingo-cell", text);
        const done = !!state.bingo[id];
        if (done) cell.classList.add("done");
        cell.onclick = () => {
          state.bingo[id] = !state.bingo[id];
          saveState();
          renderBingo();
        };
        grid.appendChild(cell);
      });
    }

    // SEARCH (Jikan API)
    function searchAnime(query) {
      return fetch(
        "https://api.jikan.moe/v4/anime?q=" +
          encodeURIComponent(query) +
          "&limit=5&order_by=score&sort=desc"
      ).then((res) => res.json());
    }

    function fetchAnimeFull(id) {
      return fetch("https://api.jikan.moe/v4/anime/" + id + "/full").then((res) => res.json());
    }

    function fetchMangaByTitle(title) {
      return fetch(
        "https://api.jikan.moe/v4/manga?q=" +
          encodeURIComponent(title) +
          "&limit=1&order_by=score&sort=desc"
      ).then((res) => res.json());
    }

       // === FIXED SEARCH RESULTS (English titles + only main anime) ===
function renderSearchResults(list) {
  const container = document.getElementById("search-results");
  container.innerHTML = "";

  // ðŸŸ¦ Prefer English title if available
  const processed = list.map(item => ({
    ...item,
    displayTitle: item.title_english || item.title || item.title_japanese
  }));

  // ðŸŸ© Filter only main TV series
  const filtered = processed.filter(item => item.type === "TV");

  if (!filtered.length) {
    container.textContent = "No main anime series found.";
    return;
  }

  // ðŸŸ§ Render clean results
  filtered.forEach(item => {
    const el = createEl("div", "search-item");
    const left = createEl(
      "div",
      null,
      `${item.displayTitle} â€¢ ${item.type} â€¢ ${item.episodes || "?"} eps â€¢ Score ${item.score ?? "?"}`
    );

    const btn = createEl("button", "small", "Details");
    btn.onclick = () => loadDetails(item.mal_id);

    el.appendChild(left);
    el.appendChild(btn);
    container.appendChild(el);
  });
} 
    function loadDetails(id) {
      const panel = document.getElementById("search-details");
      panel.style.display = "block";
      panel.textContent = "Loading details...";

      fetchAnimeFull(id)
        .then((animeRes) => {
          const animeData = animeRes.data;
          if (!animeData) throw new Error("No anime data");
          return Promise.all([
            Promise.resolve(animeData),
            fetchMangaByTitle(animeData.title).catch(() => null),
          ]);
        })
        .then(([animeData, mangaRes]) => {
          let mangaInfo = null;
          if (mangaRes && mangaRes.data && mangaRes.data.length) {
            const m = mangaRes.data[0];
            mangaInfo = {
              title: m.title,
              status: m.status,
              chapters: m.chapters,
              volumes: m.volumes,
            };
          }

          panel.innerHTML = "";
          const header = createEl("div", "details-header");
          const poster = createEl("div", "details-poster");
          if (animeData.images && animeData.images.jpg) {
            const img = document.createElement("img");
            img.src = animeData.images.jpg.image_url;
            img.alt = animeData.title;
            poster.appendChild(img);
          }
          header.appendChild(poster);

          const main = createEl("div", "details-main");
          main.appendChild(createEl("h3", null, animeData.title));
          main.appendChild(
            createEl(
              "p",
              null,
              animeData.type +
                " â€¢ " +
                (animeData.episodes || "?") +
                " eps â€¢ " +
                animeData.status +
                " â€¢ Score " +
                (animeData.score ?? "?")
            )
          );
          const genres = (animeData.genres || []).map((g) => g.name);
          if (genres.length) {
            main.appendChild(createEl("p", null, "Genres: " + genres.join(", ")));
          }
          header.appendChild(main);
          panel.appendChild(header);

          const watchBox = createEl("div");
          watchBox.appendChild(createEl("h4", null, "Watch order (basic):"));
          const rels = animeData.relations || [];
          if (!rels.length) {
            watchBox.appendChild(createEl("p", null, "No related anime info found."));
          } else {
            const list = document.createElement("ul");
            rels.forEach((rel) => {
              const relationType = rel.relation;
              (rel.entry || []).forEach((e) => {
                list.appendChild(
                  createEl("li", null, relationType + ": " + e.name + " (" + e.type + ")")
                );
              });
            });
            watchBox.appendChild(list);
          }
          panel.appendChild(watchBox);

          const mangaBox = createEl("div");
          mangaBox.appendChild(createEl("h4", null, "Manga info:"));
          if (mangaInfo) {
            mangaBox.appendChild(
              createEl(
                "p",
                null,
                mangaInfo.title +
                  " â€¢ " +
                  (mangaInfo.status || "status?") +
                  " â€¢ " +
                  (mangaInfo.chapters || "?") +
                  " chapters â€¢ " +
                  (mangaInfo.volumes || "?") +
                  " volumes"
              )
            );
          } else {
            mangaBox.appendChild(
              createEl(
                "p",
                null,
                "No manga match found or API failed. (There still might be a manga.)"
              )
            );
          }
          panel.appendChild(mangaBox);

          const btnRow = createEl("div", "anime-actions");
          const addBtn = createEl("button", null, "Add to my library (Watching)");
          addBtn.onclick = () => {
            const entry = {
              source: "jikan",
              id: animeData.mal_id,
              title: animeData.title,
              type: animeData.type,
              totalEpisodes: animeData.episodes || null,
              episodesWatched: 0,
              status: "watching",
              score: animeData.score,
              airingStatus: animeData.status,
              imageUrl:
                animeData.images && animeData.images.jpg
                  ? animeData.images.jpg.image_url
                  : "",
              minutesPerEp: 24,
              genres: genres,
              tags: [],
            };
            addOrUpdateAnime(entry);
            alert("Added to your library.");
          };
          btnRow.appendChild(addBtn);
          panel.appendChild(btnRow);
        })
        .catch((err) => {
          console.error(err);
          panel.textContent = "Failed to load details.";
        });
    }

    // MANUAL ADD
    function setupManualAdd() {
      const btn = document.getElementById("manual-add-button");
      btn.onclick = () => {
        const title = document.getElementById("manual-title").value.trim();
        const total = Number(document.getElementById("manual-total").value) || null;
        const mins = Number(document.getElementById("manual-minutes").value) || 24;
        const ep = Number(document.getElementById("manual-ep").value) || 0;
        const status = document.getElementById("manual-status").value;
        const tagsRaw = document
          .getElementById("manual-tags")
          .value.split(",")
          .map((t) => t.trim())
          .filter(Boolean);

        if (!title) {
          alert("Title is required.");
          return;
        }

        const entry = {
          source: "manual",
          id: null,
          title,
          type: "Manual",
          totalEpisodes: total,
          episodesWatched: ep,
          status,
          score: null,
          airingStatus: null,
          imageUrl: "",
          minutesPerEp: mins,
          genres: [],
          tags: tagsRaw,
        };
        addOrUpdateAnime(entry);

        document.getElementById("manual-title").value = "";
        document.getElementById("manual-total").value = "";
        document.getElementById("manual-minutes").value = "";
        document.getElementById("manual-ep").value = "";
        document.getElementById("manual-tags").value = "";
      };
    }

    // FILTER TABS
    function setupTabs() {
      const tabs = document.querySelectorAll(".status-tab");
      tabs.forEach((tab) => {
        tab.onclick = () => {
          tabs.forEach((t) => t.classList.remove("active"));
          tab.classList.add("active");
          currentFilter = tab.dataset.filter;
          renderAnimeList();
        };
      });
    }

    // SEARCH HANDLER
    function setupSearch() {
      const btn = document.getElementById("search-button");
      const input = document.getElementById("search-input");
      const results = document.getElementById("search-results");
      const details = document.getElementById("search-details");

      btn.onclick = () => {
        const q = input.value.trim();
        details.style.display = "none";
        details.innerHTML = "";
        if (!q) {
          results.textContent = "Type an anime name.";
          return;
        }
        results.textContent = "Searching...";
        searchAnime(q)
          .then((res) => {
            renderSearchResults(res.data || []);
          })
          .catch(() => {
            results.textContent = "Search failed.";
          });
      };
    }

    // INIT
    function init() {
      loadState();
      renderProfile();
      renderQuote();
      renderBingo();
      renderAnimeList();
      renderStatsAndRecs();
      setupManualAdd();
      setupTabs();
      setupSearch();
    }

    document.addEventListener("DOMContentLoaded", init);
  </script>
</body>
</html>
